[gd_resource type="ShaderMaterial" load_steps=2 format=3 uid="uid://cyl6gwipvy34i"]

[sub_resource type="Shader" id="1"]
code = "shader_type canvas_item;

/* Particle system */
uniform int particle_count = 180;
uniform float particle_size = 0.003;
uniform float particle_speed = 0.12;
uniform float particle_spread = 0.6;
uniform float particle_lifetime = 12.0;

/* Flow direction */
uniform vec2 flow_direction = vec2(0.7, -0.7);

/* Mouse */
uniform float mouse_force = 0.25;
uniform float mouse_radius = 0.12;
uniform vec2 mouse_pos;
uniform vec2 viewport_size;

/* Colors */
uniform vec3 color_min = vec3(0.6, 0.7, 1.0);
uniform vec3 color_max = vec3(1.0, 0.7, 0.8);

/* Random */
float hash(float n){
    return fract(sin(n) * 43758.5453123);
}
float rand(vec2 p){
    return fract(sin(dot(p, vec2(127.1,311.7))) * 43758.5453123);
}
vec3 rand_color(float id){
    return mix(color_min, color_max, vec3(
        hash(id * 3.1),
        hash(id * 7.2),
        hash(id * 11.4)
    ));
}

void fragment(){
    vec2 uv = UV;
    vec2 mouse = mouse_pos / viewport_size;
    float t = TIME;

    vec3 col = vec3(0.0);

    for(int i = 0; i < particle_count; i++){
        float id = float(i);

        float seed = hash(id * 13.37);
        float life = fract(t / particle_lifetime + seed);

        vec2 start = vec2(
            rand(vec2(id, 1.3)),
            rand(vec2(id, 4.7))
        );

        vec2 dir = normalize(flow_direction + vec2(
            rand(vec2(id, 9.1)) - 0.5,
            rand(vec2(id, 2.8)) - 0.5
        ) * particle_spread);

        vec2 pos = fract(start + dir * life * particle_speed);

        // Mouse push
        vec2 to_mouse = pos - mouse;
        float dist = length(to_mouse);
        if(dist < mouse_radius){
            float f = (1.0 - dist / mouse_radius);
            pos += normalize(to_mouse) * f * mouse_force;
        }

        // Fade
        float fade = smoothstep(0.0, 0.15, life) * (1.0 - smoothstep(0.7, 1.0, life));

        float d = length(uv - pos);
        float dot = smoothstep(particle_size, 0.0, d);

        col += rand_color(id) * dot * fade;
    }

    COLOR = vec4(col, 1.0);
}
"

[resource]
shader = SubResource("1")
shader_parameter/particle_count = 180
shader_parameter/particle_size = 0.003
shader_parameter/particle_speed = 0.12
shader_parameter/particle_spread = 0.6
shader_parameter/particle_lifetime = 12.0
shader_parameter/flow_direction = Vector2(0.7, -0.7)
shader_parameter/mouse_force = 0.25
shader_parameter/mouse_radius = 0.12
shader_parameter/mouse_pos = Vector2(0, 0)
shader_parameter/viewport_size = Vector2(0, 0)
shader_parameter/color_min = Vector3(0.6, 0.7, 1)
shader_parameter/color_max = Vector3(1, 0.7, 0.8)
